#!/usr/bin/env python3
"""
Quick Milton Benchmark - Tests model with WebSocket processing
"""
import json
import time
import subprocess
import sys
from pathlib import Path
from datetime import datetime
import requests
import websocket

ROOT_DIR = Path(__file__).resolve().parents[1]
sys.path.insert(0, str(ROOT_DIR))

from memory.operations import MemoryOperations

API_URL = "http://localhost:8001"


def log(msg):
    print(f"[{datetime.now().strftime('%H:%M:%S')}] {msg}")


def ask_and_wait(query, agent=None, category="test"):
    """Send query and wait for WebSocket response."""
    log(f"üìù {category.upper()}: {query[:70]}...")

    # Submit
    payload = {"query": query}
    if agent:
        payload["agent"] = agent

    resp = requests.post(f"{API_URL}/api/ask", json=payload)
    resp.raise_for_status()
    req_id = resp.json()["request_id"]

    # Connect to WebSocket
    ws_url = f"ws://localhost:8001/ws/request/{req_id}"
    ws = websocket.create_connection(ws_url, timeout=60)

    start = time.time()
    completed = False
    stored = False

    try:
        while time.time() - start < 60:
            msg = json.loads(ws.recv())

            if msg["type"] == "memory":
                stored = msg.get("stored", False)
            elif msg["type"] == "complete":
                duration = time.time() - start
                log(f"  ‚úì Completed in {duration:.1f}s | Memory: {'‚úì' if stored else '‚úó'}")
                completed = True
                break

        ws.close()
        return completed

    except Exception as e:
        log(f"  ‚úó Error: {e}")
        ws.close()
        return False


def run_benchmark():
    log("=" * 70)
    log("MILTON QUICK BENCHMARK")
    log("=" * 70)

    results = []

    # Self-Reflection
    log("\n### SELF-REFLECTION ###")
    questions = [
        "Who are you and what is your purpose?",
        "What are your strengths as an AI assistant?",
        "How could you improve to better help humans?",
    ]
    for q in questions:
        results.append(ask_and_wait(q, agent="NEXUS", category="reflection"))
        time.sleep(1)

    # Task Execution
    log("\n### TASK EXECUTION ###")
    tasks = [
        "Write a Python function for Fibonacci numbers",
        "Create a bash script to list large files",
    ]
    for t in tasks:
        results.append(ask_and_wait(t, agent="CORTEX", category="task"))
        time.sleep(1)

    # Entrepreneurial Idea
    log("\n### ENTREPRENEURIAL PROJECT ###")
    idea = """Create a Flask API for daily motivational quotes.
Include: endpoints for random/all quotes, simple data structure, error handling."""
    results.append(ask_and_wait(idea, agent="CORTEX", category="entrepreneur"))
    time.sleep(1)

    # Create Git Repo
    log("\n### GIT REPOSITORY ###")
    repo_path = ROOT_DIR / "entrepreneur_project"
    if not (repo_path / ".git").exists():
        log(f"Creating repo at {repo_path}")
        repo_path.mkdir(exist_ok=True)

        readme = repo_path / "README.md"
        readme.write_text(f"""# Daily Motivation API

Generated by Milton AI - {datetime.now().strftime('%Y-%m-%d %H:%M')}

## Benchmark Project
Created during automated benchmark testing.
""")

        subprocess.run(["git", "init"], cwd=repo_path, check=True, capture_output=True)
        subprocess.run(["git", "add", "."], cwd=repo_path, check=True, capture_output=True)
        subprocess.run(
            ["git", "commit", "-m", "Benchmark: Initial commit"],
            cwd=repo_path,
            check=True,
            capture_output=True,
        )
        log(f"  ‚úì Repository created with commit")
    else:
        log(f"  ‚äô Repository already exists")

    # Memory Check
    log("\n### MEMORY VERIFICATION ###")
    with MemoryOperations() as mem:
        collection = mem.client.collections.get("ShortTermMemory")
        result = collection.aggregate.over_all(total_count=True)
        count = result.total_count or 0
        log(f"  Vectors: {count}")

        query = collection.query.fetch_objects(limit=3)
        for obj in query.objects:
            content = obj.properties.get("content", "")[:50]
            agent = obj.properties.get("agent", "?")
            log(f"  - {agent}: {content}...")

    # Report
    log("\n" + "=" * 70)
    log("BENCHMARK RESULTS")
    log("=" * 70)

    successful = sum(1 for r in results if r)
    total = len(results)
    log(f"Success: {successful}/{total} ({successful/total*100:.0f}%)")

    # Store summary
    summary = f"Benchmark: {successful}/{total} queries successful. Tested self-reflection, task execution, and entrepreneurial ideation. Memory vectors: {count}"
    with MemoryOperations() as mem:
        mem.add_short_term(
            agent="SYSTEM",
            content=summary,
            context="Quick Benchmark",
            metadata={"timestamp": datetime.now().isoformat(), "success_rate": successful / total},
        )
    log("‚úì Summary stored for morning briefing")

    log("=" * 70)


if __name__ == "__main__":
    try:
        run_benchmark()
    except KeyboardInterrupt:
        log("\n\nBenchmark interrupted")
    except Exception as e:
        log(f"\n\nError: {e}")
        import traceback
        traceback.print_exc()
