#!/bin/bash
# Quick command to ask Milton a question
# Usage:
#   ask-milton "Your question here"           # Continue last conversation
#   ask-milton --new "Your question here"     # Start new conversation

set -e

STATE_DIR="${HOME}/.local/state/milton"
THREAD_FILE="${STATE_DIR}/current_thread_id"
GATEWAY_URL="${MILTON_GATEWAY_URL:-http://localhost:8081}"

# Parse arguments
NEW_THREAD=false
QUESTION=""

if [ "$1" = "--new" ]; then
    NEW_THREAD=true
    QUESTION="$2"
elif [ -z "$1" ]; then
    echo "Usage: ask-milton [--new] \"Your question here\""
    echo ""
    echo "Examples:"
    echo "  ask-milton \"What is the weather?\""
    echo "  ask-milton --new \"Write a Python function for factorial\""
    exit 1
else
    QUESTION="$1"
fi

# Ensure state directory exists
mkdir -p "$STATE_DIR"

# Generate or load thread ID
if [ "$NEW_THREAD" = true ] || [ ! -f "$THREAD_FILE" ]; then
    # Generate new thread ID
    THREAD_ID=$(python3 -c "import uuid; print(str(uuid.uuid4()))")
    echo "$THREAD_ID" > "$THREAD_FILE"
    MODE="[NEW]"
else
    # Use existing thread ID
    THREAD_ID=$(cat "$THREAD_FILE")
    MODE="[continuing]"
fi

echo "ğŸ“¤ Sending to Milton $MODE: $QUESTION"

# Get user's timezone (from environment or system)
USER_TIMEZONE="${TZ:-}"
if [ -z "$USER_TIMEZONE" ]; then
    # Try to detect from system timezone
    if command -v timedatectl &> /dev/null; then
        USER_TIMEZONE=$(timedatectl show -p Timezone --value 2>/dev/null)
    else
        USER_TIMEZONE="America/Chicago"
    fi
fi

# Send request to gateway with thread_id and timezone
RESPONSE=$(curl -s -X POST \
    -H "Content-Type: application/json" \
    -d @- "$GATEWAY_URL/v1/chat/completions" <<EOF
{
    "model": "claude-opus-4.5",
    "messages": [
        {
            "role": "user",
            "content": "$QUESTION"
        }
    ],
    "thread_id": "$THREAD_ID",
    "timezone": "$USER_TIMEZONE"
}
EOF
)

# Check if we got a valid response
if echo "$RESPONSE" | grep -q '"choices"'; then
    echo "âœ… Response received!"

    # Extract and display the response
    ANSWER=$(echo "$RESPONSE" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'choices' in data and len(data['choices']) > 0:
        print(data['choices'][0].get('message', {}).get('content', ''))
except:
    print('Could not parse response')
" 2>/dev/null)

    if [ -n "$ANSWER" ]; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "$ANSWER"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
else
    echo "âŒ Failed to get response from gateway"
    echo "Response: $RESPONSE"
    exit 1
fi
